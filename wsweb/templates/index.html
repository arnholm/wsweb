<!--
** Author: Carsten Arnholm, January 2022
** This code was written for my weather station project
**
** This code follows the sqlite3 license model, i.e.:
** The author disclaims copyright to this source code.  In place of
** a legal notice, here is a blessing:
**
**    May you do good and not evil.
**    May you find forgiveness for yourself and forgive others.
**    May you share freely, never taking more than you give.
-->

<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>{{ title }}</title>

    <script type = "text/javascript" src = "https://www.gstatic.com/charts/loader.js">  </script>
    <script type = "text/javascript">
       google.charts.load('current', {packages: ['corechart','line']});
    </script>
</head>
<body >

<h1>{{ title }}</h1>

<form method="POST" action="/submit" enctype="multipart/form-data">
   <label for="sensor">Sensor:</label>
   <select name="sensor" id="sensor">
   </select>
   <label for="ndays">Number of days:</label>
   <input type="number" id="ndays" name="ndays" min="1" max="1825" value="{{ndays}}" size=3>
   <input type="submit" value="Submit">
</form>

<div id = "container" style = "height: 400px; margin: 0 auto">
</div>

<script language = "JavaScript">

   <!-- fix_sensors loads the alternatives into the "sensors" selection, and sets the default-->
   window.onload = function fix_sensors()
   {
      // currently selected sensor, use quotes to make it a string
      var selected = "{{selected_sensor}}";

      // sensor names
      var sens  = [ ];
      {{#sensors}}
      sens.push("{{.}}");
      {{/sensors}}

      // sensor descriptions
      var text  = [ ];
      {{#sensors_text}}
      text.push("{{.}}");
      {{/sensors_text}}

      var selectElement = document.getElementById('sensor');
      for(var i=0; i<sens.length; i++) {
         var opt = new Option(text[i]); // this is seen by user
         if(selected == sens[i]) opt.selected=true;
         opt.value = sens[i]; // this is reported to server
         selectElement.add(opt);
      }
   }
</script>


<script language = "JavaScript">

   function drawBasic() {

      var x  = [ ];
      {{#xpoints}}
      x.push({{.}});
      {{/xpoints}}

      var y = [ ];
      {{#ypoints}}
      y.push({{.}});
      {{/ypoints}}

      // construct 2d array for addRows
      let xylen = Math.min( x.length, y.length);
      var xy = [];
      for(var i = 0; i<xylen; i++){
         xy[i] = [];
         xy[i][0] = new Date(x[i]*1000);  // date takes milliseconds from unix epocj, we have time_t values (sec)
         xy[i][1] = y[i];
      }

      var data = new google.visualization.DataTable();
      data.addColumn('datetime', 'time');
      data.addColumn('number', 'value');

      var dateFormatter = new google.visualization.DateFormat({pattern: 'dd/MM/yyyy HH:mm'});
      dateFormatter.format(data,0);

      // add the data to the table
      data.addRows(xy);
      var options = {
        hAxis: {
          title: 'Time',
          format: 'yyyy-MM-dd HH:mm'
        },
        legend: {
           position: 'none'
        },
        title: '{{yaxis}}'
      };

      var chart = new google.visualization.LineChart(document.getElementById('container'));
      chart.draw(data, options);
   }
   google.charts.setOnLoadCallback(drawBasic);

</script>
</html>
